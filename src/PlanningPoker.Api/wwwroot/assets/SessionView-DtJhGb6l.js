import{l as L,j as h,u as j,f as y,c as u,a as e,t as v,m as _,n as C,e as k,o as l,F as A,p as E,h as p,q as S,s as P,b as U,k as T,w as z,r as Y,x as R}from"./index-BprJ669h.js";import{u as w,a as F}from"./sessionStore-C5IN-seR.js";function H(){const g=w(),d=j(),i=h(null),t=h(!1),r=h(0),s=5;function o(x,m){n();const V=`/api/sessions/${x}/events?userId=${m}`;i.value=new EventSource(V),i.value.onopen=()=>{t.value=!0,r.value=0,g.isConnected=!0,g.updateUserConnectionStatus(m,!0)},i.value.onerror=()=>{if(t.value=!1,g.isConnected=!1,g.updateUserConnectionStatus(m,!1),r.value<s){r.value++;const B=2e3*r.value;setTimeout(()=>{r.value<=s&&o(x,m)},B)}},i.value.addEventListener("user_joined",b),i.value.addEventListener("user_left",c),i.value.addEventListener("user_connected",a),i.value.addEventListener("user_disconnected",f),i.value.addEventListener("voting_started",$),i.value.addEventListener("vote_submitted",O),i.value.addEventListener("votes_revealed",D),i.value.addEventListener("votes_reset",I),i.value.addEventListener("session_closed",J)}function n(){i.value&&(i.value.close(),i.value=null,t.value=!1,g.isConnected=!1)}function b(x){const m=JSON.parse(x.data);g.addUser({id:m.id,name:m.name,isOwner:m.isOwner,joinedAt:new Date(m.joinedAt),isConnected:m.isConnected??!1})}function c(x){const m=JSON.parse(x.data);g.removeUser(m.userId)}function a(x){const m=JSON.parse(x.data);g.updateUserConnectionStatus(m.userId,!0)}function f(x){const m=JSON.parse(x.data);g.updateUserConnectionStatus(m.userId,!1)}function $(x){const m=JSON.parse(x.data);g.startVoting({id:m.id,startedAt:new Date(m.startedAt)})}function O(x){const m=JSON.parse(x.data);g.updateVote({userId:m.userId,userName:m.userName,value:null,submittedAt:new Date})}function D(x){const m=JSON.parse(x.data);g.revealVotes({results:m.results,votes:m.votes.map(V=>({...V,submittedAt:new Date(V.submittedAt)}))})}function I(){g.resetVotes()}function J(){n(),alert("The session has been closed by the owner"),d.push("/")}return L(()=>{n()}),{isConnected:t,connect:o,disconnect:n}}const M={class:"bg-white rounded-lg shadow-lg p-6"},q={class:"flex flex-col md:flex-row md:items-center md:justify-between gap-4"},W={class:"flex items-center gap-2 text-sm text-gray-600"},G={class:"flex items-center gap-2 mt-1"},K={class:"flex flex-col sm:flex-row gap-3"},Q={class:"bg-gray-100 rounded-lg p-4 text-center"},X={class:"text-2xl font-mono font-bold text-gray-800"},Z=y({__name:"SessionInfo",setup(g){const d=w(),i=_(()=>d.session),t=_(()=>d.isConnected),r=h(!1);function s(){var n;const o=`${window.location.origin}/join/${(n=i.value)==null?void 0:n.sessionCode}`;navigator.clipboard.writeText(o),r.value=!0,setTimeout(()=>{r.value=!1},2e3)}return(o,n)=>{var b,c;return l(),u("div",M,[e("div",q,[e("div",null,[n[1]||(n[1]=e("h1",{class:"text-2xl font-bold text-gray-800 mb-2"},"Planning Poker Session",-1)),e("div",W,[n[0]||(n[0]=e("span",{class:"font-medium"},"Owner:",-1)),e("span",null,v((b=i.value)==null?void 0:b.ownerName),1)]),e("div",G,[e("span",{class:C(["inline-flex items-center px-2 py-1 rounded-full text-xs font-medium",t.value?"bg-green-100 text-green-800":"bg-red-100 text-red-800"])},[e("span",{class:C(["w-2 h-2 rounded-full mr-1",t.value?"bg-green-500":"bg-red-500"])},null,2),k(" "+v(t.value?"Connected":"Disconnected"),1)],2)])]),e("div",K,[e("div",Q,[n[2]||(n[2]=e("div",{class:"text-xs text-gray-600 mb-1"},"Session Code",-1)),e("div",X,v((c=i.value)==null?void 0:c.sessionCode),1)]),e("button",{onClick:s,class:"bg-primary hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center gap-2"},[n[3]||(n[3]=e("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"})],-1)),k(" "+v(r.value?"Copied!":"Share Link"),1)])])])])}}}),ee={class:"bg-white rounded-lg shadow-lg p-6"},te={class:"text-xl font-bold text-gray-800 mb-4"},se={class:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"},ne={class:"relative flex-shrink-0"},oe=["title"],re={class:"flex-1 min-w-0"},ie={class:"font-medium text-gray-800 truncate"},ae={key:0,class:"text-primary font-semibold"},le={key:0,class:"text-xs text-gray-500"},de={key:1,class:"text-xs text-secondary font-medium"},ue=y({__name:"UserList",setup(g){const d=w(),i=_(()=>{var n;return((n=d.session)==null?void 0:n.users)||[]}),t=_(()=>d.currentRound),r=_(()=>{var n;return(n=d.currentUser)==null?void 0:n.id});function s(n){return n===r.value}function o(n){return!t.value||t.value.status!=="InProgress"?!1:t.value.votes.some(b=>b.userId===n)}return(n,b)=>(l(),u("div",ee,[e("h2",te," Participants ("+v(i.value.length)+") ",1),e("div",se,[(l(!0),u(A,null,E(i.value,c=>(l(),u("div",{key:c.id,class:C(["flex items-center gap-3 p-3 rounded-lg",s(c.id)?"bg-primary/10 ring-2 ring-primary/30":"bg-gray-50"])},[e("div",ne,[e("div",{class:C(["w-10 h-10 rounded-full flex items-center justify-center text-white font-bold",s(c.id)?"bg-primary ring-2 ring-primary/50":"bg-primary"])},v(c.name.charAt(0).toUpperCase()),3),e("div",{class:C(["absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 rounded-full border-2 border-white",c.isConnected?"bg-green-500":"bg-red-500"]),title:c.isConnected?"Connected":"Disconnected"},null,10,oe)]),e("div",re,[e("div",ie,[k(v(c.name)+" ",1),s(c.id)?(l(),u("span",ae,"(You)")):p("",!0)]),c.isOwner?(l(),u("div",le,"Admin")):p("",!0),o(c.id)?(l(),u("div",de," ✓ Voted ")):p("",!0)])],2))),128))])]))}}),ce={class:"bg-white rounded-lg shadow-lg p-6"},ve={class:"flex flex-wrap gap-3"},ge=["disabled"],me=["disabled"],fe=["disabled"],xe=["disabled"],be={key:0,class:"mt-4 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg"},pe=y({__name:"AdminControls",setup(g){const d=F(),i=j(),t=w(),r=h(!1),s=h(null);async function o(){if(!(!t.session||!t.currentUser)){r.value=!0,s.value=null;try{await d.startVoting(t.session.sessionCode,t.currentUser.id)}catch(a){s.value=a instanceof Error?a.message:"Failed to start voting"}finally{r.value=!1}}}async function n(){if(!(!t.session||!t.currentUser)){r.value=!0,s.value=null;try{await d.revealVotes(t.session.sessionCode,t.currentUser.id)}catch(a){s.value=a instanceof Error?a.message:"Failed to reveal votes"}finally{r.value=!1}}}async function b(){if(!(!t.session||!t.currentUser)){r.value=!0,s.value=null;try{await d.resetVotes(t.session.sessionCode,t.currentUser.id)}catch(a){s.value=a instanceof Error?a.message:"Failed to reset votes"}finally{r.value=!1}}}async function c(){if(!(!t.session||!t.currentUser||!confirm("Are you sure you want to close this session? All participants will be disconnected."))){r.value=!0,s.value=null;try{await d.closeSession(t.session.sessionCode,t.currentUser.id),t.reset(),i.push("/")}catch(f){s.value=f instanceof Error?f.message:"Failed to close session"}finally{r.value=!1}}}return(a,f)=>(l(),u("div",ce,[f[0]||(f[0]=e("h2",{class:"text-xl font-bold text-gray-800 mb-4"},"Admin Controls",-1)),e("div",ve,[S(t).canStartVoting?(l(),u("button",{key:0,onClick:o,disabled:r.value,class:"bg-secondary hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed"},v(r.value?"Starting...":"Start Voting"),9,ge)):p("",!0),S(t).canReveal?(l(),u("button",{key:1,onClick:n,disabled:r.value,class:"bg-primary hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed"},v(r.value?"Revealing...":"Reveal Votes"),9,me)):p("",!0),S(t).canReset?(l(),u("button",{key:2,onClick:b,disabled:r.value,class:"bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed"},v(r.value?"Resetting...":"New Round"),9,fe)):p("",!0),e("button",{onClick:c,disabled:r.value,class:"bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed"},v(r.value?"Closing...":"Close Session"),9,xe)]),s.value?(l(),u("div",be,v(s.value),1)):p("",!0)]))}}),N=[1,2,3,5,8,13,21];function _e(){function g(i){return N.includes(i)}function d(){return[...N]}return{values:N,isValidValue:g,getValues:d}}const he={class:"bg-white rounded-lg shadow-lg p-6"},ye={class:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-7 gap-4"},we=["onClick","disabled"],$e={key:0,class:"mt-4 text-center text-sm text-gray-600"},Ce={class:"font-bold text-primary"},Se={key:1,class:"mt-4 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg"},ke=y({__name:"VotingCards",setup(g){const d=F(),i=_e(),t=w(),r=h(!1),s=h(null),o=_(()=>t.currentVote);function n(c){var a;return((a=o.value)==null?void 0:a.value)===c}async function b(c){if(!(!t.session||!t.currentUser)){r.value=!0,s.value=null;try{await d.submitVote(t.session.sessionCode,t.currentUser.id,c),t.updateVote({userId:t.currentUser.id,userName:t.currentUser.name,value:c,submittedAt:new Date})}catch(a){s.value=a instanceof Error?a.message:"Failed to submit vote"}finally{r.value=!1}}}return(c,a)=>(l(),u("div",he,[a[2]||(a[2]=e("h2",{class:"text-xl font-bold text-gray-800 mb-4"},"Select Your Estimate",-1)),e("div",ye,[(l(!0),u(A,null,E(S(i).values,f=>(l(),u("button",{key:f,onClick:$=>b(f),disabled:r.value,class:C(["aspect-[3/4] rounded-lg font-bold text-2xl transition duration-200 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed",n(f)?"bg-primary text-white ring-4 ring-blue-300":"bg-gray-100 hover:bg-gray-200 text-gray-800"])},v(f),11,we))),128))]),o.value?(l(),u("div",$e,[a[0]||(a[0]=k(" Your current vote: ",-1)),e("span",Ce,v(o.value.value),1),a[1]||(a[1]=e("span",{class:"text-gray-500 ml-2"},"(You can change it anytime)",-1))])):p("",!0),s.value?(l(),u("div",Se,v(s.value),1)):p("",!0)]))}}),Ve={class:"space-y-3"},Ue={class:"w-12 text-right font-bold text-gray-700"},Ae={class:"flex-1 bg-gray-200 rounded-full h-10 relative overflow-hidden"},Ee={class:"text-white font-bold text-sm"},Re={class:"w-12 text-left text-sm text-gray-600"},Ne={class:"mt-4 text-sm text-gray-600 text-center"},je=y({__name:"VoteDistribution",props:{distribution:{},total:{}},setup(g){const d=g,i=_(()=>{const r=Object.entries(d.distribution).map(([s,o])=>[Number(s),o]).sort((s,o)=>s[0]-o[0]);return Object.fromEntries(r)});function t(r){return d.total===0?0:r/d.total*100}return(r,s)=>(l(),u("div",null,[s[0]||(s[0]=e("h3",{class:"text-lg font-semibold text-gray-800 mb-4"},"Vote Distribution",-1)),e("div",Ve,[(l(!0),u(A,null,E(i.value,(o,n)=>(l(),u("div",{key:n,class:"flex items-center gap-3"},[e("div",Ue,v(n),1),e("div",Ae,[e("div",{class:"bg-gradient-to-r from-primary to-blue-600 h-full rounded-full flex items-center justify-end px-3 transition-all duration-500",style:P({width:`${t(o)}%`})},[e("span",Ee,v(o),1)],4)]),e("div",Re,v(t(o).toFixed(0))+"% ",1)]))),128))]),e("div",Ne," Total votes: "+v(g.total),1)]))}}),Fe={key:0,class:"space-y-6"},Le={class:"bg-white rounded-lg shadow-lg p-6"},Oe={class:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"},De={class:"bg-blue-50 rounded-lg p-4 text-center"},Ie={class:"text-3xl font-bold text-primary"},Je={class:"bg-green-50 rounded-lg p-4 text-center"},Be={class:"text-3xl font-bold text-secondary"},Pe={class:"bg-purple-50 rounded-lg p-4 text-center"},Te={class:"text-3xl font-bold text-purple-600"},ze={class:"bg-white rounded-lg shadow-lg p-6"},Ye={class:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"},He={class:"flex items-center gap-3"},Me={class:"flex-shrink-0 w-10 h-10 bg-primary rounded-full flex items-center justify-center text-white font-bold"},qe={class:"font-medium text-gray-800"},We={class:"text-2xl font-bold text-primary"},Ge=y({__name:"VotingResults",setup(g){const d=w(),i=_(()=>d.currentRound),t=_(()=>{var s;return(s=i.value)==null?void 0:s.results}),r=_(()=>{var s;return(s=i.value)!=null&&s.votes?[...i.value.votes].sort((o,n)=>o.value===null?1:n.value===null?-1:o.value-n.value):[]});return(s,o)=>t.value?(l(),u("div",Fe,[e("div",Le,[o[6]||(o[6]=e("h2",{class:"text-2xl font-bold text-gray-800 mb-6"},"Voting Results",-1)),e("div",Oe,[e("div",De,[o[0]||(o[0]=e("div",{class:"text-sm text-gray-600 mb-1"},"Low Estimate",-1)),e("div",Ie,v(t.value.lowFibonacciAverage),1),o[1]||(o[1]=e("div",{class:"text-xs text-gray-500 mt-1"},"Closest Fibonacci ≤ average",-1))]),e("div",Je,[o[2]||(o[2]=e("div",{class:"text-sm text-gray-600 mb-1"},"Average",-1)),e("div",Be,v(t.value.actualAverage.toFixed(1)),1),o[3]||(o[3]=e("div",{class:"text-xs text-gray-500 mt-1"},"Arithmetic mean",-1))]),e("div",Pe,[o[4]||(o[4]=e("div",{class:"text-sm text-gray-600 mb-1"},"High Estimate",-1)),e("div",Te,v(t.value.highFibonacciAverage),1),o[5]||(o[5]=e("div",{class:"text-xs text-gray-500 mt-1"},"Closest Fibonacci ≥ average",-1))])]),U(je,{distribution:t.value.distribution,total:t.value.totalVotes},null,8,["distribution","total"])]),e("div",ze,[o[7]||(o[7]=e("h3",{class:"text-xl font-bold text-gray-800 mb-4"},"All Votes",-1)),e("div",Ye,[(l(!0),u(A,null,E(r.value,n=>(l(),u("div",{key:n.userId,class:"flex items-center justify-between p-3 bg-gray-50 rounded-lg"},[e("div",He,[e("div",Me,v(n.userName.charAt(0).toUpperCase()),1),e("div",qe,v(n.userName),1)]),e("div",We,v(n.value),1)]))),128))])])])):p("",!0)}}),Ke={class:"min-h-screen bg-gray-50"},Qe={key:0,class:"flex items-center justify-center min-h-screen"},Xe={key:1,class:"flex items-center justify-center min-h-screen"},Ze={class:"bg-white rounded-lg shadow-xl p-8 max-w-md"},et={class:"text-center"},tt={class:"text-gray-700 mb-6"},st={key:2,class:"container mx-auto px-4 py-8 max-w-6xl"},nt={class:"mt-6"},ot={class:"mt-8"},rt={key:0,class:"mt-8"},it={key:1,class:"mt-8 text-center"},at={class:"bg-white rounded-lg shadow p-8"},lt={class:"text-gray-600 text-lg"},ct=y({__name:"SessionView",props:{code:{}},setup(g){const d=g,i=j(),t=F(),r=H(),s=w(),o=h(!0),n=h(null),b=_(()=>s.session),c=_(()=>s.currentRound);return T(async()=>{try{if(!s.session||s.session.sessionCode!==d.code){const a=await t.getSession(d.code);s.setSession(a)}if(!s.currentUser){const{user:a,sessionCode:f}=s.restoreFromStorage();if(a&&f===d.code)try{const $=await t.joinSession(d.code,a.name);s.setCurrentUser($)}catch{i.push(`/join/${d.code}`);return}else{i.push(`/join/${d.code}`);return}}r.connect(d.code,s.currentUser.id),o.value=!1}catch(a){n.value=a instanceof Error?a.message:"Failed to load session",o.value=!1}}),L(()=>{r.disconnect()}),(a,f)=>{const $=Y("router-link");return l(),u("div",Ke,[o.value?(l(),u("div",Qe,[...f[0]||(f[0]=[e("div",{class:"text-center"},[e("div",{class:"text-2xl font-semibold text-gray-700"}," Loading session... ")],-1)])])):n.value?(l(),u("div",Xe,[e("div",Ze,[e("div",et,[f[2]||(f[2]=e("div",{class:"text-red-600 text-xl font-semibold mb-4"},"Error",-1)),e("div",tt,v(n.value),1),U($,{to:"/",class:"inline-block bg-primary hover:bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg transition duration-200"},{default:z(()=>[...f[1]||(f[1]=[k(" Back to Home ",-1)])]),_:1})])])])):b.value?(l(),u("div",st,[U(Z),e("div",nt,[U(ue)]),e("div",ot,[S(s).isOwner?(l(),R(pe,{key:0})):p("",!0)]),c.value?(l(),u("div",rt,[c.value.status==="InProgress"?(l(),R(ke,{key:0})):c.value.status==="Revealed"?(l(),R(Ge,{key:1})):p("",!0)])):(l(),u("div",it,[e("div",at,[e("p",lt,v(S(s).isOwner?'Click "Start Voting" to begin a new round':"Waiting for the admin to start voting..."),1)])]))])):p("",!0)])}}});export{ct as default};
