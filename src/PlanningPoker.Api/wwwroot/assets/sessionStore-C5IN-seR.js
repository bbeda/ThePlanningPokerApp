import{j as f,y as _,m as c}from"./index-BprJ669h.js";function $(){const s="planning-poker-browser-id";let r=localStorage.getItem(s);return r||(r=crypto.randomUUID(),localStorage.setItem(s,r)),r}const x="/api";function D(){const s=f(!1),r=f(null);async function l(n,u){s.value=!0,r.value=null;try{const a=await fetch(`${x}${n}`,{...u,headers:{"Content-Type":"application/json",...u==null?void 0:u.headers}});if(!a.ok){const T=await a.json().catch(()=>({error:a.statusText}));throw new Error(T.error||`HTTP ${a.status}`)}return a.status===204?null:await a.json()}catch(a){throw r.value=a instanceof Error?a.message:"Unknown error",a}finally{s.value=!1}}async function v(n){return l("/sessions",{method:"POST",body:JSON.stringify({ownerName:n,browserId:$()})})}async function t(n){return l(`/sessions/${n}`)}async function I(n,u){return l(`/sessions/${n}/users`,{method:"POST",body:JSON.stringify({sessionCode:n,userName:u,browserId:$()})})}async function m(n,u){return l(`/sessions/${n}/users/${u}`,{method:"DELETE"})}async function E(n,u){return l(`/sessions/${n}/voting/start?userId=${u}`,{method:"POST"})}async function y(n,u,a){return l(`/sessions/${n}/voting/votes?userId=${u}`,{method:"POST",body:JSON.stringify({value:a})})}async function R(n,u){return l(`/sessions/${n}/voting/reveal?userId=${u}`,{method:"POST"})}async function O(n,u){return l(`/sessions/${n}/voting/reset?userId=${u}`,{method:"POST"})}async function h(n,u){return l(`/sessions/${n}?userId=${u}`,{method:"DELETE"})}return{loading:s,error:r,createSession:v,getSession:t,joinSession:I,leaveSession:m,startVoting:E,submitVote:y,revealVotes:R,resetVotes:O,closeSession:h}}const d={CURRENT_USER:"planning-poker-current-user",SESSION_CODE:"planning-poker-session-code"},b=_("session",()=>{const s=f(null),r=f(null),l=f(!1),v=c(()=>{var e,o;return((e=r.value)==null?void 0:e.id)===((o=s.value)==null?void 0:o.ownerId)}),t=c(()=>{var e;return(e=s.value)==null?void 0:e.currentRound}),I=c(()=>!t.value||!r.value?!1:t.value.votes.some(e=>e.userId===r.value.id)),m=c(()=>!t.value||!r.value?null:t.value.votes.find(e=>e.userId===r.value.id)),E=c(()=>{var e,o;return v.value&&((e=t.value)==null?void 0:e.status)==="InProgress"&&(((o=t.value)==null?void 0:o.votes.length)??0)>0}),y=c(()=>{var e;return v.value&&((e=t.value)==null?void 0:e.status)==="Revealed"}),R=c(()=>v.value&&!t.value);function O(e){s.value=e,localStorage.setItem(d.SESSION_CODE,e.sessionCode)}function h(e){r.value=e,localStorage.setItem(d.CURRENT_USER,JSON.stringify(e))}function n(e){s.value&&s.value.users.findIndex(i=>i.id===e.id)===-1&&s.value.users.push(e)}function u(e){s.value&&(s.value.users=s.value.users.filter(o=>o.id!==e))}function a(e,o){if(s.value){const i=s.value.users.find(S=>S.id===e);i&&(i.isConnected=o)}}function T(e){s.value&&(s.value.currentRound={id:e.id,status:"InProgress",startedAt:e.startedAt,revealedAt:null,votes:[],results:null})}function p(e){var o;if(t.value){const i=t.value.votes.findIndex(g=>g.userId===e.userId),S=e.userId===((o=r.value)==null?void 0:o.id);if(i>=0){const g=t.value.votes[i].value;t.value.votes[i]={...e,value:t.value.status==="Revealed"||S||g!==null?e.value??g:null}}else t.value.votes.push({...e,value:t.value.status==="Revealed"||S?e.value:null})}}function w(e){t.value&&(t.value.status="Revealed",t.value.revealedAt=new Date,t.value.results=e.results,t.value.votes=e.votes)}function C(){s.value&&(s.value.currentRound=null)}function N(){const e=localStorage.getItem(d.CURRENT_USER),o=localStorage.getItem(d.SESSION_CODE);if(e)try{r.value=JSON.parse(e)}catch{r.value=null}return{user:r.value,sessionCode:o}}function U(){localStorage.removeItem(d.CURRENT_USER),localStorage.removeItem(d.SESSION_CODE)}function V(){s.value=null,r.value=null,l.value=!1,U()}return{session:s,currentUser:r,isConnected:l,isOwner:v,currentRound:t,hasVoted:I,currentVote:m,canReveal:E,canReset:y,canStartVoting:R,setSession:O,setCurrentUser:h,addUser:n,removeUser:u,updateUserConnectionStatus:a,startVoting:T,updateVote:p,revealVotes:w,resetVotes:C,restoreFromStorage:N,clearStorage:U,reset:V}});export{D as a,b as u};
